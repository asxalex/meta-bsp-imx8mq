From ed8f9c3745b831a730c0e4306d55e1606851fa94 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Tue, 12 Nov 2019 18:49:06 +0200
Subject: [PATCH 20/20] cl-som-imx8: ddr4: Make lpddr4 work on 800MHz

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 board/compulab/cl-som-imx8/ddr/lpddr4_timing_1g.c | 97 ++++++++++++-----------
 board/compulab/cl-som-imx8/ddr/lpddr4_timing_2g.c | 97 ++++++++++++-----------
 2 files changed, 98 insertions(+), 96 deletions(-)

diff --git a/board/compulab/cl-som-imx8/ddr/lpddr4_timing_1g.c b/board/compulab/cl-som-imx8/ddr/lpddr4_timing_1g.c
index 4b2cd0f..026df6c 100644
--- a/board/compulab/cl-som-imx8/ddr/lpddr4_timing_1g.c
+++ b/board/compulab/cl-som-imx8/ddr/lpddr4_timing_1g.c
@@ -16,40 +16,40 @@ static struct dram_cfg_param ddr_ddrc_cfg[] = {
 	{0x3d400030,0x1},
 	{0x3d400000,0xa1080020},
 	{0x3d400028,0x0},
-	{0x3d400020,0x203},
-	{0x3d400024,0x3e800},
-	{0x3d400064,0x610090},
-	{0x3d4000d0,0xc003061c},
-	{0x3d4000d4,0x9e0000},
-	{0x3d4000dc,0xd4002d},
+	{0x3d400020,0x101},
+	{0x3d400024,0x1f400},
+	{0x3d400064,0x300048},
+	{0x3d4000d0,0xc002030f},
+	{0x3d4000d4,0x500000},
+	{0x3d4000dc,0xa40012},
 	{0x3d4000e0,0x310008},
 	{0x3d4000e8,0x66004a},
 	{0x3d4000ec,0x16004a},
-	{0x3d400100,0x1a201b22},
-	{0x3d400104,0x60633},
-	{0x3d40010c,0xc0c000},
-	{0x3d400110,0xf04080f},
-	{0x3d400114,0x2040c0c},
-	{0x3d400118,0x1010007},
-	{0x3d40011c,0x401},
-	{0x3d400130,0x20600},
-	{0x3d400134,0xc100002},
-	{0x3d400138,0x96},
-	{0x3d400144,0xa00050},
-	{0x3d400180,0xc3200018},
-	{0x3d400184,0x28061a8},
+	{0x3d400100,0x10100d11},
+	{0x3d400104,0x3041a},
+	{0x3d40010c,0x606000},
+	{0x3d400110,0x8040408},
+	{0x3d400114,0x2030606},
+	{0x3d400118,0x1010004},
+	{0x3d40011c,0x301},
+	{0x3d400130,0x20300},
+	{0x3d400134,0xa100002},
+	{0x3d400138,0x4b},
+	{0x3d400144,0x500028},
+	{0x3d400180,0xc190000c},
+	{0x3d400184,0x14030d4},
 	{0x3d400188,0x0},
-	{0x3d400190,0x497820a},
+	{0x3d400190,0x4898204},
 	{0x3d400194,0x80303},
 	{0x3d4001a0,0xe0400018},
 	{0x3d4001a4,0xdf00e4},
 	{0x3d4001a8,0x80000000},
 	{0x3d4001b0,0x11},
-	{0x3d4001b4,0x170a},
+	{0x3d4001b4,0x904},
 	{0x3d4001c0,0x1},
 	{0x3d4001c4,0x1},
 	{0x3d4000f4,0x639},
-	{0x3d400108,0x70e1617},
+	{0x3d400108,0x4070f0f},
 	{0x3d400200,0x1f},
 	{0x3d40020c,0x0},
 	{0x3d400210,0x1f1f},
@@ -167,9 +167,9 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x7055,0x1ff},
 	{0x8055,0x1ff},
 	{0x9055,0x1ff},
-	{0x200c5,0x19},
+	{0x200c5,0xb},
 	{0x1200c5,0x7},
-	{0x2002e,0x2},
+	{0x2002e,0x1},
 	{0x12002e,0x1},
 	{0x90204,0x0},
 	{0x190204,0x0},
@@ -177,7 +177,7 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x2003a,0x0},
 	{0x120024,0x1ab},
 	{0x2003a,0x0},
-	{0x20056,0x3},
+	{0x20056,0xa},
 	{0x120056,0xa},
 	{0x1004d,0xe00},
 	{0x1014d,0xe00},
@@ -224,7 +224,7 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x20018,0x3},
 	{0x20075,0x4},
 	{0x20050,0x0},
-	{0x20008,0x320},
+	{0x20008,0x190},
 	{0x120008,0xa7},
 	{0x20088,0x9},
 	{0x200b2,0xdc},
@@ -991,7 +991,7 @@ static struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 /* P0 message block paremeter for training firmware */
 static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0xd0000, 0x0},
-	{0x54003,0xc80},
+	{0x54003,0x640},
 	{0x54004,0x2},
 	{0x54005,0x2228},
 	{0x54006,0x11},
@@ -1000,26 +1000,26 @@ static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0x5400b,0x2},
 	{0x5400d,0x100},
 	{0x54012,0x110},
-	{0x54019,0x2dd4},
+	{0x54019,0x12a4},
 	{0x5401a,0x31},
 	{0x5401b,0x4a66},
 	{0x5401c,0x4a08},
 	{0x5401e,0x16},
-	{0x5401f,0x2dd4},
+	{0x5401f,0x12a4},
 	{0x54020,0x31},
 	{0x54021,0x4a66},
 	{0x54022,0x4a08},
 	{0x54024,0x16},
 	{0x5402b,0x1000},
 	{0x5402c,0x1},
-	{0x54032,0xd400},
-	{0x54033,0x312d},
+	{0x54032,0xa400},
+	{0x54033,0x3112},
 	{0x54034,0x6600},
 	{0x54035,0x84a},
 	{0x54036,0x4a},
 	{0x54037,0x1600},
-	{0x54038,0xd400},
-	{0x54039,0x312d},
+	{0x54038,0xa400},
+	{0x54039,0x3112},
 	{0x5403a,0x6600},
 	{0x5403b,0x84a},
 	{0x5403c,0x4a},
@@ -1072,7 +1072,7 @@ static struct dram_cfg_param ddr_fsp1_cfg[] = {
 /* P0 2D message block paremeter for training firmware */
 static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0xd0000, 0x0},
-	{0x54003,0xc80},
+	{0x54003,0x640},
 	{0x54004,0x2},
 	{0x54005,0x2228},
 	{0x54006,0x11},
@@ -1082,26 +1082,26 @@ static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0x5400f,0x100},
 	{0x54010,0x1f7f},
 	{0x54012,0x110},
-	{0x54019,0x2dd4},
+	{0x54019,0x12a4},
 	{0x5401a,0x31},
 	{0x5401b,0x4a66},
 	{0x5401c,0x4a08},
 	{0x5401e,0x16},
-	{0x5401f,0x2dd4},
+	{0x5401f,0x12a4},
 	{0x54020,0x31},
 	{0x54021,0x4a66},
 	{0x54022,0x4a08},
 	{0x54024,0x16},
 	{0x5402b,0x1000},
 	{0x5402c,0x1},
-	{0x54032,0xd400},
-	{0x54033,0x312d},
+	{0x54032,0xa400},
+	{0x54033,0x3112},
 	{0x54034,0x6600},
 	{0x54035,0x84a},
 	{0x54036,0x4a},
 	{0x54037,0x1600},
-	{0x54038,0xd400},
-	{0x54039,0x312d},
+	{0x54038,0xa400},
+	{0x54039,0x3112},
 	{0x5403a,0x6600},
 	{0x5403b,0x84a},
 	{0x5403c,0x4a},
@@ -1599,9 +1599,9 @@ static struct dram_cfg_param ddr_phy_pie[] = {
 	{0x400d6,0x20a},
 	{0x400d7,0x20b},
 	{0x2003a,0x2},
-	{0x2000b,0x64},
-	{0x2000c,0xc8},
-	{0x2000d,0x7d0},
+	{0x2000b,0x32},
+	{0x2000c,0x64},
+	{0x2000d,0x3e8},
 	{0x2000e,0x2c},
 	{0x12000b,0x14},
 	{0x12000c,0x29},
@@ -1695,8 +1695,8 @@ static struct dram_cfg_param ddr_phy_pie[] = {
 
 static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 	{
-		/* P0 3200mts 1D */
-		.drate = 3200,
+		/* P0 1600mts 1D */
+		.drate = 1600,
 		.fw_type = FW_1D_IMAGE,
 		.fsp_cfg = ddr_fsp0_cfg,
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp0_cfg),
@@ -1709,8 +1709,8 @@ static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp1_cfg),
 	},
 	{
-		/* P0 3200mts 2D */
-		.drate = 3200,
+		/* P0 1600mts 2D */
+		.drate = 1600,
 		.fw_type = FW_2D_IMAGE,
 		.fsp_cfg = ddr_fsp0_2d_cfg,
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp0_2d_cfg),
@@ -1729,5 +1729,6 @@ struct dram_timing_info dram_timing_1g = {
 	.ddrphy_trained_csr_num = ARRAY_SIZE(ddr_ddrphy_trained_csr),
 	.ddrphy_pie = ddr_phy_pie,
 	.ddrphy_pie_num = ARRAY_SIZE(ddr_phy_pie),
-	.fsp_table = { 3200, 667, },
+	.fsp_table = { 1600, 667, },
 };
+
diff --git a/board/compulab/cl-som-imx8/ddr/lpddr4_timing_2g.c b/board/compulab/cl-som-imx8/ddr/lpddr4_timing_2g.c
index 9173c57..1d3a0d0 100644
--- a/board/compulab/cl-som-imx8/ddr/lpddr4_timing_2g.c
+++ b/board/compulab/cl-som-imx8/ddr/lpddr4_timing_2g.c
@@ -16,40 +16,40 @@ static struct dram_cfg_param ddr_ddrc_cfg[] = {
 	{0x3d400030,0x1},
 	{0x3d400000,0xa3080020},
 	{0x3d400028,0x0},
-	{0x3d400020,0x203},
-	{0x3d400024,0x3e800},
-	{0x3d400064,0x6100e0},
-	{0x3d4000d0,0xc003061c},
-	{0x3d4000d4,0x9e0000},
-	{0x3d4000dc,0xd4002d},
+	{0x3d400020,0x101},
+	{0x3d400024,0x1f400},
+	{0x3d400064,0x300070},
+	{0x3d4000d0,0xc002030f},
+	{0x3d4000d4,0x500000},
+	{0x3d4000dc,0xa40012},
 	{0x3d4000e0,0x310008},
 	{0x3d4000e8,0x66004a},
 	{0x3d4000ec,0x16004a},
-	{0x3d400100,0x1a201b22},
-	{0x3d400104,0x60633},
-	{0x3d40010c,0xc0c000},
-	{0x3d400110,0xf04080f},
-	{0x3d400114,0x2040c0c},
-	{0x3d400118,0x1010007},
-	{0x3d40011c,0x401},
-	{0x3d400130,0x20600},
-	{0x3d400134,0xc100002},
-	{0x3d400138,0xe6},
-	{0x3d400144,0xa00050},
-	{0x3d400180,0xc3200018},
-	{0x3d400184,0x28061a8},
+	{0x3d400100,0x10100d11},
+	{0x3d400104,0x3041a},
+	{0x3d40010c,0x606000},
+	{0x3d400110,0x8040408},
+	{0x3d400114,0x2030606},
+	{0x3d400118,0x1010004},
+	{0x3d40011c,0x301},
+	{0x3d400130,0x20300},
+	{0x3d400134,0xa100002},
+	{0x3d400138,0x73},
+	{0x3d400144,0x500028},
+	{0x3d400180,0xc190000c},
+	{0x3d400184,0x14030d4},
 	{0x3d400188,0x0},
-	{0x3d400190,0x497820a},
+	{0x3d400190,0x4898204},
 	{0x3d400194,0x80303},
 	{0x3d4001a0,0xe0400018},
 	{0x3d4001a4,0xdf00e4},
 	{0x3d4001a8,0x80000000},
 	{0x3d4001b0,0x11},
-	{0x3d4001b4,0x170a},
+	{0x3d4001b4,0x904},
 	{0x3d4001c0,0x1},
 	{0x3d4001c4,0x1},
 	{0x3d4000f4,0x639},
-	{0x3d400108,0x70e1617},
+	{0x3d400108,0x4070f0f},
 	{0x3d400200,0x16},
 	{0x3d40020c,0x0},
 	{0x3d400210,0x1f1f},
@@ -167,9 +167,9 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x7055,0x1ff},
 	{0x8055,0x1ff},
 	{0x9055,0x1ff},
-	{0x200c5,0x19},
+	{0x200c5,0xb},
 	{0x1200c5,0x7},
-	{0x2002e,0x2},
+	{0x2002e,0x1},
 	{0x12002e,0x1},
 	{0x90204,0x0},
 	{0x190204,0x0},
@@ -177,7 +177,7 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x2003a,0x0},
 	{0x120024,0x1ab},
 	{0x2003a,0x0},
-	{0x20056,0x3},
+	{0x20056,0xa},
 	{0x120056,0xa},
 	{0x1004d,0xe00},
 	{0x1014d,0xe00},
@@ -224,7 +224,7 @@ static struct dram_cfg_param ddr_ddrphy_cfg[] = {
 	{0x20018,0x3},
 	{0x20075,0x4},
 	{0x20050,0x0},
-	{0x20008,0x320},
+	{0x20008,0x190},
 	{0x120008,0xa7},
 	{0x20088,0x9},
 	{0x200b2,0xdc},
@@ -991,7 +991,7 @@ static struct dram_cfg_param ddr_ddrphy_trained_csr[] = {
 /* P0 message block paremeter for training firmware */
 static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0xd0000, 0x0},
-	{0x54003,0xc80},
+	{0x54003,0x640},
 	{0x54004,0x2},
 	{0x54005,0x2228},
 	{0x54006,0x11},
@@ -1000,26 +1000,26 @@ static struct dram_cfg_param ddr_fsp0_cfg[] = {
 	{0x5400b,0x2},
 	{0x5400d,0x100},
 	{0x54012,0x310},
-	{0x54019,0x2dd4},
+	{0x54019,0x12a4},
 	{0x5401a,0x31},
 	{0x5401b,0x4a66},
 	{0x5401c,0x4a08},
 	{0x5401e,0x16},
-	{0x5401f,0x2dd4},
+	{0x5401f,0x12a4},
 	{0x54020,0x31},
 	{0x54021,0x4a66},
 	{0x54022,0x4a08},
 	{0x54024,0x16},
 	{0x5402b,0x1000},
 	{0x5402c,0x3},
-	{0x54032,0xd400},
-	{0x54033,0x312d},
+	{0x54032,0xa400},
+	{0x54033,0x3112},
 	{0x54034,0x6600},
 	{0x54035,0x84a},
 	{0x54036,0x4a},
 	{0x54037,0x1600},
-	{0x54038,0xd400},
-	{0x54039,0x312d},
+	{0x54038,0xa400},
+	{0x54039,0x3112},
 	{0x5403a,0x6600},
 	{0x5403b,0x84a},
 	{0x5403c,0x4a},
@@ -1072,7 +1072,7 @@ static struct dram_cfg_param ddr_fsp1_cfg[] = {
 /* P0 2D message block paremeter for training firmware */
 static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0xd0000, 0x0},
-	{0x54003,0xc80},
+	{0x54003,0x640},
 	{0x54004,0x2},
 	{0x54005,0x2228},
 	{0x54006,0x11},
@@ -1082,26 +1082,26 @@ static struct dram_cfg_param ddr_fsp0_2d_cfg[] = {
 	{0x5400f,0x100},
 	{0x54010,0x1f7f},
 	{0x54012,0x310},
-	{0x54019,0x2dd4},
+	{0x54019,0x12a4},
 	{0x5401a,0x31},
 	{0x5401b,0x4a66},
 	{0x5401c,0x4a08},
 	{0x5401e,0x16},
-	{0x5401f,0x2dd4},
+	{0x5401f,0x12a4},
 	{0x54020,0x31},
 	{0x54021,0x4a66},
 	{0x54022,0x4a08},
 	{0x54024,0x16},
 	{0x5402b,0x1000},
 	{0x5402c,0x3},
-	{0x54032,0xd400},
-	{0x54033,0x312d},
+	{0x54032,0xa400},
+	{0x54033,0x3112},
 	{0x54034,0x6600},
 	{0x54035,0x84a},
 	{0x54036,0x4a},
 	{0x54037,0x1600},
-	{0x54038,0xd400},
-	{0x54039,0x312d},
+	{0x54038,0xa400},
+	{0x54039,0x3112},
 	{0x5403a,0x6600},
 	{0x5403b,0x84a},
 	{0x5403c,0x4a},
@@ -1599,9 +1599,9 @@ static struct dram_cfg_param ddr_phy_pie[] = {
 	{0x400d6,0x20a},
 	{0x400d7,0x20b},
 	{0x2003a,0x2},
-	{0x2000b,0x64},
-	{0x2000c,0xc8},
-	{0x2000d,0x7d0},
+	{0x2000b,0x32},
+	{0x2000c,0x64},
+	{0x2000d,0x3e8},
 	{0x2000e,0x2c},
 	{0x12000b,0x14},
 	{0x12000c,0x29},
@@ -1695,8 +1695,8 @@ static struct dram_cfg_param ddr_phy_pie[] = {
 
 static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 	{
-		/* P0 3200mts 1D */
-		.drate = 3200,
+		/* P0 1600mts 1D */
+		.drate = 1600,
 		.fw_type = FW_1D_IMAGE,
 		.fsp_cfg = ddr_fsp0_cfg,
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp0_cfg),
@@ -1709,8 +1709,8 @@ static struct dram_fsp_msg ddr_dram_fsp_msg[] = {
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp1_cfg),
 	},
 	{
-		/* P0 3200mts 2D */
-		.drate = 3200,
+		/* P0 1600mts 2D */
+		.drate = 1600,
 		.fw_type = FW_2D_IMAGE,
 		.fsp_cfg = ddr_fsp0_2d_cfg,
 		.fsp_cfg_num = ARRAY_SIZE(ddr_fsp0_2d_cfg),
@@ -1729,5 +1729,6 @@ struct dram_timing_info dram_timing_2g = {
 	.ddrphy_trained_csr_num = ARRAY_SIZE(ddr_ddrphy_trained_csr),
 	.ddrphy_pie = ddr_phy_pie,
 	.ddrphy_pie_num = ARRAY_SIZE(ddr_phy_pie),
-	.fsp_table = { 3200, 667, },
+	.fsp_table = { 1600, 667, },
 };
+
-- 
1.9.1

