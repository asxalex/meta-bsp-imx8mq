From f6d1d3364f4f7b2ebba0642a71d34ac3ef3b339d Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Fri, 8 May 2020 18:00:11 +0300
Subject: [PATCH 51/51] cl-som-imx8: Add psci_system_off() call

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm/mach-imx/imx8m/soc.c            | 2 +-
 board/compulab/cl-som-imx8/cl-som-imx8.c | 9 +++++++++
 configs/cl-som-imx8_defconfig            | 1 +
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/arch/arm/mach-imx/imx8m/soc.c b/arch/arm/mach-imx/imx8m/soc.c
index 35fb2cb8d5..d8b16a8ed3 100644
--- a/arch/arm/mach-imx/imx8m/soc.c
+++ b/arch/arm/mach-imx/imx8m/soc.c
@@ -920,7 +920,7 @@ usb_modify_speed:
 }
 #endif
 
-void reset_cpu(ulong addr)
+__weak void reset_cpu(ulong addr)
 {
 	struct watchdog_regs *wdog = (struct watchdog_regs *)WDOG1_BASE_ADDR;
 
diff --git a/board/compulab/cl-som-imx8/cl-som-imx8.c b/board/compulab/cl-som-imx8/cl-som-imx8.c
index f30be9cb8c..a743284978 100644
--- a/board/compulab/cl-som-imx8/cl-som-imx8.c
+++ b/board/compulab/cl-som-imx8/cl-som-imx8.c
@@ -447,3 +447,12 @@ struct display_info_t const displays[] = {{
 size_t display_count = ARRAY_SIZE(displays);
 
 #endif /* CONFIG_VIDEO_IMXDCSS */
+void reset_cpu(ulong addr)
+{
+	psci_system_reset();
+}
+
+int do_poweroff(cmd_tbl_t *cmdtp, int flag, int argc, char * const argv[])
+{
+	psci_system_off();
+}
diff --git a/configs/cl-som-imx8_defconfig b/configs/cl-som-imx8_defconfig
index 911918f273..f32eb0dd32 100644
--- a/configs/cl-som-imx8_defconfig
+++ b/configs/cl-som-imx8_defconfig
@@ -19,6 +19,7 @@ CONFIG_CMD_MEMINFO=y
 CONFIG_CMD_MEMTEST=y
 CONFIG_CMD_GPIO=y
 CONFIG_CMD_I2C=y
+CONFIG_CMD_POWEROFF=y
 CONFIG_CMD_CACHE=y
 CONFIG_CMD_PMIC=y
 CONFIG_CMD_REGULATOR=y
-- 
2.11.0

