From 412566cf128eba3fe926345eeaed7916742bfc3a Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Thu, 2 Jan 2020 15:57:17 +0200
Subject: [PATCH 1/2] imx8mq: Take the dram_size detected by SPL

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 plat/imx/imx8mq/imx8mq_bl31_setup.c | 29 ++++++++++++++++++++++++++++-
 1 file changed, 28 insertions(+), 1 deletion(-)

diff --git a/plat/imx/imx8mq/imx8mq_bl31_setup.c b/plat/imx/imx8mq/imx8mq_bl31_setup.c
index 155a11a..5edfd36 100644
--- a/plat/imx/imx8mq/imx8mq_bl31_setup.c
+++ b/plat/imx/imx8mq/imx8mq_bl31_setup.c
@@ -328,8 +328,35 @@ void bl31_early_platform_setup2(u_register_t arg0, u_register_t arg1,
 
 }
 
+#define TCM_DATA_CFG 0x7e0000
+typedef unsigned long phys_size_t;
+static phys_size_t imx8_ddr_size(void)
+{
+    unsigned long value = mmio_read_32(TCM_DATA_CFG);
+    phys_size_t dram_size = 0x40000000;;
+
+    switch (value) {
+    case 4096:
+        value = 3084;
+    case 3084:
+    case 2048:
+    case 1536:
+    case 1024:
+    case 768:
+    case 512:
+    case 256:
+        dram_size = ( value << 20 );
+        break;
+    default:
+        break;
+    };
+    return dram_size;
+}
+
 void bl31_plat_arch_setup(void)
 {
+	phys_size_t dram_size = imx8_ddr_size();
+	NOTICE("SPL detected memsize 0x%lx\n", dram_size);
 	/* add the mmap */
 	mmap_add_region(0x900000, 0x900000, 0x20000,
 			MT_MEMORY | MT_RW);
@@ -339,7 +366,7 @@ void bl31_plat_arch_setup(void)
 	mmap_add_region(0x180000, 0x180000, 0x8000,
 			MT_MEMORY | MT_RW);
 
-	mmap_add_region(0x40000000, 0x40000000, 0xc0000000,
+	mmap_add_region(0x40000000, 0x40000000, dram_size,
 			MT_MEMORY | MT_RW | MT_NS);
 
 	mmap_add_region(BL31_BASE, BL31_BASE, BL31_RO_LIMIT - BL31_RO_BASE,
-- 
1.9.1

