From 77e62da0f7fd90a716b0681f39cc5ca972bef0e4 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Fri, 22 Mar 2019 20:17:35 +0200
Subject: [PATCH 3/8] cl-som-imx8: Update Android support

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 configs/cl-som-imx8_android_defconfig | 42 ++++++++++++++++++++++++++++++-----
 include/configs/cl-som-imx8_android.h | 27 +++++++++++-----------
 2 files changed, 50 insertions(+), 19 deletions(-)

diff --git a/configs/cl-som-imx8_android_defconfig b/configs/cl-som-imx8_android_defconfig
index 38b446b..8315fe5 100644
--- a/configs/cl-som-imx8_android_defconfig
+++ b/configs/cl-som-imx8_android_defconfig
@@ -1,27 +1,41 @@
 CONFIG_ARM=y
 CONFIG_ARCH_IMX8M=y
+CONFIG_SYS_TEXT_BASE=0x40200000
 CONFIG_SYS_MALLOC_F_LEN=0x2000
-CONFIG_TARGET_CL_SOM_IMX8=y
+CONFIG_TARGET_COMPULAB_IMX8=y
+CONFIG_FLASH_MCUFIRMWARE_SUPPORT=y
 CONFIG_DEFAULT_DEVICE_TREE="cl-som-imx8"
+CONFIG_LOCALVERSION="-cl-som-imx8-1.1"
 CONFIG_FIT=y
 CONFIG_SPL_LOAD_FIT=y
-CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=arch/arm/imx-common/spl_sd.cfg,ANDROID_SUPPORT"
-CONFIG_EFI_PARTITION=y
+CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=arch/arm/mach-imx/spl_sd.cfg,ANDROID_SUPPORT"
+CONFIG_DEFAULT_FDT_FILE="sbc-imx8.dtb"
+CONFIG_ARCH_MISC_INIT=y
 CONFIG_SPL=y
+CONFIG_SPL_BOARD_INIT=y
 CONFIG_HUSH_PARSER=y
-CONFIG_CMD_I2C=y
+CONFIG_CMD_MEMINFO=y
+CONFIG_CMD_MEMTEST=y
 CONFIG_CMD_GPIO=y
+CONFIG_CMD_I2C=y
 CONFIG_CMD_CACHE=y
 CONFIG_CMD_PMIC=y
 CONFIG_CMD_REGULATOR=y
+CONFIG_CMD_EXT2=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_EXT4_WRITE=y
+CONFIG_CMD_FAT=y
 CONFIG_CMD_FS_GENERIC=y
+CONFIG_EFI_PARTITION=y
+# CONFIG_SPL_EFI_PARTITION is not set
+# CONFIG_PARTITION_UUIDS is not set
 CONFIG_OF_CONTROL=y
-# CONFIG_BLK is not set
+CONFIG_ENV_IS_IN_MMC=y
+CONFIG_SAVED_DRAM_TIMING_BASE=0x40000000
 CONFIG_DM_GPIO=y
 CONFIG_DM_I2C=y
 CONFIG_SYS_I2C_MXC=y
 CONFIG_DM_MMC=y
-# CONFIG_DM_MMC_OPS is not set
 CONFIG_DM_ETH=y
 CONFIG_PINCTRL=y
 CONFIG_PINCTRL_IMX8M=y
@@ -33,3 +47,19 @@ CONFIG_DM_REGULATOR_FIXED=y
 CONFIG_DM_REGULATOR_GPIO=y
 CONFIG_DM_THERMAL=y
 CONFIG_NXP_TMU=y
+CONFIG_USB=y
+CONFIG_DM_USB=y
+CONFIG_USB_XHCI_HCD=y
+CONFIG_USB_XHCI_DWC3=y
+CONFIG_USB_EHCI_HCD=y
+CONFIG_USB_DWC3=y
+CONFIG_USB_DWC3_GADGET=y
+CONFIG_USB_GADGET=y
+CONFIG_USB_GADGET_MANUFACTURER="FSL"
+CONFIG_USB_GADGET_VENDOR_NUM=0x0525
+CONFIG_USB_GADGET_PRODUCT_NUM=0xa4a5
+CONFIG_SDP_LOADADDR=0x40400000
+CONFIG_USB_GADGET_DOWNLOAD=y
+CONFIG_VIDEO=y
+CONFIG_VIDEO_IMX8_HDMI=y
+CONFIG_LZ4=y
diff --git a/include/configs/cl-som-imx8_android.h b/include/configs/cl-som-imx8_android.h
index 2c27993..8bf9e4b 100644
--- a/include/configs/cl-som-imx8_android.h
+++ b/include/configs/cl-som-imx8_android.h
@@ -7,8 +7,6 @@
 #ifndef __CL_SOM_IMX8_ANDROID_H
 #define __CL_SOM_IMX8_ANDROID_H
 
-#define CONFIG_BOOTLOADER_OFFSET_33K
-#define CONFIG_BCB_SUPPORT
 #define CONFIG_CMD_READ
 
 #define CONFIG_ANDROID_AB_SUPPORT
@@ -23,21 +21,11 @@
 
 #ifdef CONFIG_SYS_MALLOC_LEN
 #undef CONFIG_SYS_MALLOC_LEN
-#define CONFIG_SYS_MALLOC_LEN           (64 * SZ_1M)
+#define CONFIG_SYS_MALLOC_LEN           (96 * SZ_1M)
 #endif
 
-#define CONFIG_USB_FUNCTION_FASTBOOT
-#define CONFIG_CMD_FASTBOOT
-#define CONFIG_ANDROID_BOOT_IMAGE
-#define CONFIG_FASTBOOT_FLASH
-#define CONFIG_FASTBOOT_STORAGE_MMC
-
-#define CONFIG_FSL_FASTBOOT
 #define CONFIG_ANDROID_RECOVERY
 
-#define CONFIG_FASTBOOT_BUF_ADDR   CONFIG_SYS_LOAD_ADDR
-#define CONFIG_FASTBOOT_BUF_SIZE   0x19000000
-
 #define CONFIG_CMD_BOOTA
 #define CONFIG_SUPPORT_RAW_INITRD
 
@@ -49,4 +37,17 @@
 	"fdt_high=0xffffffffffffffff\0"		\
 	"initrd_high=0xffffffffffffffff\0"	\
 
+/* Enable mcu firmware flash */
+#ifdef CONFIG_FLASH_MCUFIRMWARE_SUPPORT
+#define ANDROID_MCU_FRIMWARE_DEV_TYPE DEV_MMC
+#define ANDROID_MCU_FIRMWARE_START 0x500000
+#define ANDROID_MCU_FIRMWARE_SIZE  0x40000
+#define ANDROID_MCU_FIRMWARE_HEADER_STACK 0x20020000
+#endif
+
+#ifdef CONFIG_FSL_CAAM_KB
+#undef CONFIG_FSL_CAAM_KB
+#endif
+#define AVB_AB_I_UNDERSTAND_LIBAVB_AB_IS_DEPRECATED
+
 #endif /* __CL_SOM_IMX8_ANDROID_H */
-- 
1.9.1

